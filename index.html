<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chester's Planner (V30 Final - Full Option)</title>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: '#e11d48', primary: '#0f172a' }, fontFamily: { sans: ['Sarabun', 'sans-serif'] } }
            }
        }
    </script>
    <style>
        body { background-color: #f1f5f9; color: #1e293b; }
        .hidden { display: none !important; }
        .tab-active { background-color: #e11d48; color: white; box-shadow: 0 4px 6px -1px rgba(225, 29, 72, 0.4); }
        .tab-inactive { background-color: white; color: #64748b; border: 1px solid #e2e8f0; }
        .animate-up { animation: fadeInUp 0.4s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Simple Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #e11d48; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-brand text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-lg"><i class="fa-solid fa-store"></i></div>
                <div>
                    <h1 class="font-bold text-slate-800 leading-none">Chester's <span class="text-brand font-light">Planner </span></h1>
                    <p class="text-[10px] text-slate-400 leading-none">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</p>
                </div>
            </div>
            <button onclick="location.reload()" class="text-slate-400 hover:text-brand"><i class="fa-solid fa-rotate-right"></i></button>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 py-6 w-full">
        
        <!-- Upload Area -->
        <div id="upload-screen" class="flex flex-col items-center justify-center py-10 animate-up">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</h2>
            <p class="text-slate-500 mb-6 text-sm">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á POS (TIS-620)</p>
            
            <div class="bg-white p-8 rounded-xl shadow-lg border-2 border-dashed border-slate-300 w-full max-w-md text-center hover:border-brand transition-colors">
                <input type="file" id="file-input" accept=".csv" class="hidden" onchange="handleFile(this.files[0])">
                <button onclick="document.getElementById('file-input').click()" class="bg-slate-50 hover:bg-slate-100 text-slate-700 px-6 py-4 rounded-lg font-bold transition-colors mb-4 w-full border border-slate-200">
                    <i class="fa-solid fa-cloud-arrow-up text-2xl mb-2 block text-slate-400"></i>
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV
                </button>
                <div class="flex items-center justify-center gap-2 text-sm text-slate-500 bg-slate-50 p-2 rounded">
                    <span>‡∏£‡∏´‡∏±‡∏™‡∏†‡∏≤‡∏©‡∏≤:</span>
                    <select id="encoding-select" class="border rounded px-2 py-1 bg-white focus:outline-none focus:ring-1 focus:ring-brand">
                        <option value="TIS-620" selected>Thai (TIS-620)</option>
                        <option value="UTF-8">UTF-8</option>
                    </select>
                </div>
            </div>
            
            <!-- Demo Button -->
            <button onclick="loadDemo()" class="mt-4 text-xs text-slate-400 underline">‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
        </div>

        <!-- Dashboard Area -->
        <div id="dashboard-screen" class="hidden space-y-6 pb-20">
            
            <!-- Tabs -->
            <div class="flex overflow-x-auto gap-2 pb-2 sticky top-20 z-40 bg-[#f1f5f9]/95 backdrop-blur px-1 pt-2 -mx-1">
                <button onclick="switchTab('overview', this)" class="whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold shadow-sm transition-all tab-active"><i class="fa-solid fa-chart-pie mr-1"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
                <button onclick="switchTab('material', this)" class="whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold shadow-sm transition-all tab-inactive"><i class="fa-solid fa-calculator mr-1"></i> ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</button>
                <button onclick="switchTab('packaging', this)" class="whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold shadow-sm transition-all tab-inactive"><i class="fa-solid fa-box-open mr-1"></i> ‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</button>
                <button onclick="switchTab('planning', this)" class="whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold shadow-sm transition-all tab-inactive"><i class="fa-solid fa-clock mr-1"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</button>
                <button onclick="switchTab('order', this)" class="whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold shadow-sm transition-all tab-inactive"><i class="fa-solid fa-truck-ramp-box mr-1"></i> ‡πÅ‡∏ú‡∏ô‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á</button>
            </div>

            <!-- 1. Overview -->
            <div id="view-overview" class="view-section space-y-4 animate-up">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500">
                        <div class="text-xs text-slate-500 font-bold uppercase">‡πÑ‡∏Å‡πà‡∏™‡∏î BL (‡∏ä‡∏¥‡πâ‡∏ô)</div>
                        <div class="text-2xl font-bold text-slate-800" id="kpi-bl">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
                        <div class="text-xs text-slate-500 font-bold uppercase">‡πÑ‡∏Å‡πà‡∏ï‡∏±‡∏î 8 (‡∏ä‡∏¥‡πâ‡∏ô)</div>
                        <div class="text-2xl font-bold text-slate-800" id="kpi-cut8">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500">
                        <div class="text-xs text-slate-500 font-bold uppercase">Block (‡∏ä‡∏¥‡πâ‡∏ô)</div>
                        <div class="text-2xl font-bold text-slate-800" id="kpi-block">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <div class="text-xs text-slate-500 font-bold uppercase">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ó‡∏µ‡πà)</div>
                        <div class="text-2xl font-bold text-slate-800" id="kpi-sales">0</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-trophy mr-2 text-yellow-500"></i> 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</h3>
                        <div class="h-80 w-full"><canvas id="chart-top10"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-chart-line mr-2 text-blue-500"></i> ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</h3>
                        <div class="h-80 w-full"><canvas id="chart-hourly"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 2. Material Breakdown -->
            <div id="view-material" class="view-section hidden space-y-4 animate-up">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-orange-100">
                        <h3 class="font-bold text-orange-600 mb-2 border-b pb-2">‡πÑ‡∏Å‡πà BL ‡∏™‡∏î</h3>
                        <div class="overflow-y-auto max-h-96"><table class="w-full text-sm"><tbody id="table-bl"></tbody></table></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-yellow-100">
                        <h3 class="font-bold text-yellow-600 mb-2 border-b pb-2">‡πÑ‡∏Å‡πà‡∏ï‡∏±‡∏î 8</h3>
                        <div class="overflow-y-auto max-h-96"><table class="w-full text-sm"><tbody id="table-cut8"></tbody></table></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-emerald-100">
                        <h3 class="font-bold text-emerald-600 mb-2 border-b pb-2">BL Block</h3>
                        <div class="overflow-y-auto max-h-96"><table class="w-full text-sm"><tbody id="table-block"></tbody></table></div>
                    </div>
                 </div>
            </div>

            <!-- 3. Packaging -->
            <div id="view-packaging" class="view-section hidden space-y-6 animate-up">
                <!-- Controller -->
                <div class="bg-slate-800 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h3 class="font-bold text-lg"><i class="fa-solid fa-sliders mr-2"></i>‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</h3>
                            <p class="text-xs text-slate-400">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å Delivery (100%) + ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (‡∏ï‡∏≤‡∏° % ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</p>
                        </div>
                        <div class="w-full md:w-1/2 bg-slate-700 p-4 rounded-lg">
                            <div class="flex justify-between text-sm mb-2">
                                <span>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô:</span>
                                <span class="font-bold text-brand text-lg" id="disp-percent">30%</span>
                            </div>
                            <input type="range" id="slider-percent" min="0" max="100" value="30" class="w-full" oninput="updatePackaging(this.value)">
                            <div class="flex justify-between text-[10px] text-slate-400 mt-1"><span>0% (‡∏ó‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏°‡∏î)</span><span>100% (‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏î)</span></div>
                        </div>
                    </div>
                    
                    <!-- Leftover Input -->
                    <div class="mt-4 flex items-center gap-3 bg-slate-900/50 p-3 rounded border border-slate-600">
                         <span class="text-sm">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏´‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö):</span>
                         <input type="number" id="input-leftover" value="15" class="w-16 bg-white text-slate-800 rounded px-2 py-1 text-center" onchange="updatePackaging()">
                         <span class="text-xs text-slate-400">‡∏Ñ‡∏ô/‡∏ß‡∏±‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á/‡∏ä‡πâ‡∏≠‡∏ô)</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-6 rounded-xl shadow-sm text-center border-b-4 border-blue-500">
                        <div class="text-sm text-slate-500 font-bold">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏ß 2 ‡∏ä‡πà‡∏≠‡∏á</div>
                        <div class="text-4xl font-bold text-blue-600 my-2" id="pkg-rice">0</div>
                        <div class="text-xs text-slate-400">Delivery: <b id="pkg-rice-del">0</b> | Walk: <b id="pkg-rice-wi">0</b></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm text-center border-b-4 border-gray-500">
                        <div class="text-sm text-slate-500 font-bold">‡∏ä‡πâ‡∏≠‡∏ô-‡∏™‡πâ‡∏≠‡∏° (‡∏Ñ‡∏π‡πà)</div>
                        <div class="text-4xl font-bold text-gray-700 my-2" id="pkg-spoon">0</div>
                        <div class="text-xs text-slate-400">Delivery: <b id="pkg-spoon-del">0</b> | Walk: <b id="pkg-spoon-wi">0</b></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm text-center border-b-4 border-orange-500">
                        <div class="text-sm text-slate-500 font-bold">‡∏°‡∏µ‡∏î-‡∏™‡πâ‡∏≠‡∏° (‡∏Ñ‡∏π‡πà)</div>
                        <div class="text-4xl font-bold text-orange-600 my-2" id="pkg-knife">0</div>
                        <div class="text-xs text-slate-400">Delivery: <b id="pkg-knife-del">0</b> | Walk: <b id="pkg-knife-wi">0</b></div>
                    </div>
                </div>

                <!-- Plan Order Table -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-blue-50 border-b border-blue-100 flex justify-between items-center">
                        <h3 class="font-bold text-blue-800"><i class="fa-solid fa-cart-shopping mr-2"></i>‡πÅ‡∏ú‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå (Safety Stock 15%)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-600">
                                <tr>
                                    <th class="px-6 py-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th class="px-6 py-3 text-right">‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th>
                                    <th class="px-6 py-3 text-right text-green-600">‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Stock)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                <tr>
                                    <td class="px-6 py-3 font-medium">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏ß 2 ‡∏ä‡πà‡∏≠‡∏á</td>
                                    <td class="px-6 py-3 text-right" id="plan-use-rice">0</td>
                                    <td class="px-6 py-3 text-right font-bold text-lg text-green-600" id="plan-order-rice">0</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-3 font-medium">‡∏ä‡πâ‡∏≠‡∏ô-‡∏™‡πâ‡∏≠‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß)</td>
                                    <td class="px-6 py-3 text-right" id="plan-use-spoon">0</td>
                                    <td class="px-6 py-3 text-right font-bold text-lg text-green-600" id="plan-order-spoon">0</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-3 font-medium">‡∏°‡∏µ‡∏î-‡∏™‡πâ‡∏≠‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏Å‡πà/‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß)</td>
                                    <td class="px-6 py-3 text-right" id="plan-use-knife">0</td>
                                    <td class="px-6 py-3 text-right font-bold text-lg text-green-600" id="plan-order-knife">0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- 4. Planning (Prep Schedule) -->
            <div id="view-planning" class="view-section hidden space-y-6 animate-up">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-clock mr-2 text-brand"></i> ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</h3>
                    <div class="h-80 w-full"><canvas id="chart-prep"></canvas></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b border-slate-100 font-bold text-slate-700">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡∏ä‡∏¥‡πâ‡∏ô)</div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="px-6 py-3">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    <th class="px-6 py-3 text-orange-600">BL ‡∏™‡∏î</th>
                                    <th class="px-6 py-3 text-yellow-600">‡πÑ‡∏Å‡πà‡∏ï‡∏±‡∏î 8</th>
                                    <th class="px-6 py-3 text-green-600">Block</th>
                                    <th class="px-6 py-3 text-right font-bold">‡∏£‡∏ß‡∏°</th>
                                </tr>
                            </thead>
                            <tbody id="table-prep" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. Order Suggestion (Food) -->
            <div id="view-order" class="view-section hidden space-y-6 animate-up">
                <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 text-center">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">üì¶ ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏Å‡πà</h2>
                    <p class="text-slate-500 mb-8">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î + ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Safety Stock 10%</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="p-6 rounded-xl border-2 border-orange-100 bg-orange-50/50">
                            <h4 class="text-slate-600 font-bold mb-2">‡πÑ‡∏Å‡πà BL ‡∏™‡∏î</h4>
                            <div class="text-4xl font-bold text-orange-600" id="suggest-bl">0</div>
                            <div class="text-xs text-orange-400 mt-2">‡∏ä‡∏¥‡πâ‡∏ô</div>
                        </div>
                        <div class="p-6 rounded-xl border-2 border-yellow-100 bg-yellow-50/50">
                            <h4 class="text-slate-600 font-bold mb-2">‡πÑ‡∏Å‡πà‡∏ï‡∏±‡∏î 8</h4>
                            <div class="text-4xl font-bold text-yellow-600" id="suggest-cut8">0</div>
                            <div class="text-xs text-yellow-400 mt-2">‡∏ä‡∏¥‡πâ‡∏ô</div>
                        </div>
                        <div class="p-6 rounded-xl border-2 border-emerald-100 bg-emerald-50/50">
                            <h4 class="text-slate-600 font-bold mb-2">‡πÑ‡∏Å‡πà Block</h4>
                            <div class="text-4xl font-bold text-emerald-600" id="suggest-block">0</div>
                            <div class="text-xs text-emerald-400 mt-2">‡∏ä‡∏¥‡πâ‡∏ô</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- Core Data ---
        let cleanRows = [];
        let hourlyPrepData = {};
        let chartHourly = null;
        let chartPrep = null;
        let chartTop10 = null;
        let packagingData = { del:{r:0,s:0,k:0}, wi:{r:0,s:0,k:0} };
        let daysInFile = 1;

        // --- Configs ---
        const TARGETS = {
            BL: ["Signature 3","C2","Signature 2","Signature+‡πÇ‡∏Ñ‡πâ‡∏Å","A3","B1","B2","B3","B5","C1","C3","Signature","‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Å‡πà‡πÄ‡∏ú‡πá‡∏î","‡∏Ç‡πâ‡∏≤‡∏ß‡∏≠‡∏ö‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á","‡πÑ‡∏Å‡πà‡∏Å‡∏£‡∏≠‡∏ö‡∏ã‡∏≠‡∏™‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤","‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Å‡πà‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤","‡∏¢‡∏≥‡πÑ‡∏ó‡∏¢","‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≥‡∏ï‡∏Å","‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Å‡πà‡πÄ‡∏ú‡πá‡∏î‡∏ã‡∏≠‡∏™‡∏°‡∏±‡∏ô‡∏õ‡∏π","149","‡πÇ‡∏ó‡∏™‡∏ï‡πå‡πÅ‡∏£‡πá‡∏û‡πÑ‡∏Å‡πà‡πÄ‡∏ú‡πá‡∏î"],
            CUT8: ["PB3","A1","A2","5 ‡∏ä‡∏¥‡πâ‡∏ô","‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏ú‡πá‡∏î","49 ‡∏ö."],
            // Added 'cat' to delivery keys
            DELIVERY_KEYS: ["cat", "catering", "‡∏à‡∏±‡∏î‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á", "‡∏Å‡∏•‡πà‡∏≠‡∏á", "box", "‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô", "take away", "delivery", "‡∏´‡πà‡∏≠", "partner", "‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ô‡∏≠‡∏£‡πå", "grab", "lineman", "foodpanda", "shopee", "robinhood", "app", "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á", "‡πÅ‡∏≠‡∏õ", "‡πÅ‡∏≠‡∏û"]
        };

        // --- Helpers ---
        function clean(val) {
            if (val === undefined || val === null) return "";
            // Super Cleaner: Remove ' at start, quotes, and trim
            return String(val).replace(/^['"]/, "").replace(/['"]$/, "").trim();
        }
        function cleanNum(val) {
            // Remove ' and , then parse
            let s = clean(val).replace(/,/g, "");
            let n = parseFloat(s);
            return isNaN(n) ? 0 : n;
        }

        // --- File Handling ---
        function handleFile(file) {
            if(!file) return;
            const encoding = document.getElementById('encoding-select').value;
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                encoding: encoding,
                complete: function(results) {
                    if (results.data && results.data.length > 1) {
                        processData(results.data);
                    } else {
                        alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                    }
                }
            });
        }

        function processData(rows) {
            // 1. Find Header
            let headerIdx = -1;
            for(let i=0; i<Math.min(50, rows.length); i++) {
                let rowStr = JSON.stringify(rows[i]).toLowerCase();
                if(rowStr.includes("product") && rowStr.includes("name")) { headerIdx = i; break; }
            }
            if(headerIdx === -1) { alert("‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠"); return; }

            // 2. Map Cols
            const headers = rows[headerIdx].map(h => clean(h).toLowerCase());
            const idxName = headers.findIndex(h => h.includes("product") && h.includes("name"));
            const idxTotal = headers.findIndex(h => h === "total" || h === "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°");
            const idxCode = headers.findIndex(h => h.includes("pma") && h.includes("code"));
            const idxDesc = headers.findIndex(h => h.includes("pma") && h.includes("desc"));
            const idxDate = headers.findIndex(h => h.includes("date") || h.includes("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"));

            // 3. Time Cols
            let timeCols = [];
            headers.forEach((h, i) => {
                if(h.includes(":") && /\d/.test(h) && !h.includes("date")) {
                    timeCols.push({ idx: i, label: clean(rows[headerIdx][i]) });
                }
            });
            hourlyPrepData = {};
            let hourlySales = {};
            timeCols.forEach(t => {
                hourlyPrepData[t.label] = { bl: 0, cut8: 0, block: 0, total_sales: 0 };
                hourlySales[t.label] = 0;
            });

            // 4. Process
            cleanRows = [];
            let totalSales = 0;
            let sumBL=0, sumCut8=0, sumBlock=0;
            let productSummary = {};
            let uniqueDates = new Set();
            packagingData = { del:{r:0,s:0,k:0}, wi:{r:0,s:0,k:0} };

            for(let i = headerIdx + 1; i < rows.length; i++) {
                let row = rows[i];
                if(row.length <= idxName) continue;

                let name = clean(row[idxName]);
                let qty = cleanNum(row[idxTotal]);
                let code = idxCode > -1 ? clean(row[idxCode]) : "";
                let desc = idxDesc > -1 ? clean(row[idxDesc]) : "";

                if(!name || qty <= 0) continue;

                if(idxDate > -1) uniqueDates.add(clean(row[idxDate]));
                totalSales += qty;

                // Product Summary
                if(!productSummary[name]) productSummary[name] = 0;
                productSummary[name] += qty;

                // Materials
                let mulBL = 0, mulCut8 = 0, mulBlock = 0;
                let nameNoSpace = name.replace(/\s/g, "");

                if(!name.includes("B4") && !name.includes("B6")) {
                     if(nameNoSpace.includes("149") && name.includes("‡πÑ‡∏Å‡πà‡πÄ‡∏ú‡πá‡∏î")) mulBL = 1;
                     else {
                         let found = TARGETS.BL.find(k => name.includes(k));
                         if(found) {
                             if(name.includes("3 ‡∏ó‡∏µ‡πà")) mulBL = 3;
                             else if(name.includes("2 ‡∏ó‡∏µ‡πà")) mulBL = 2;
                             else if(name.includes("‡πÇ‡∏ó‡∏™‡∏ï‡πå")) mulBL = 0.5;
                             else mulBL = 1;
                         }
                     }
                }
                if(TARGETS.CUT8.some(k => nameNoSpace.includes(k.replace(/\s/g,"")))) {
                    if(name.includes("5 ‡∏ä‡∏¥‡πâ‡∏ô")) mulCut8 = 5;
                    else if(name.includes("8 ‡∏ä‡∏¥‡πâ‡∏ô")) mulCut8 = 8;
                    else mulCut8 = 1;
                }
                if((name.includes("‡πÑ‡∏Å‡πà‡∏Å‡∏£‡∏≠‡∏ö") && !name.includes("‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤")) || name.includes("‡∏™‡πÇ‡∏ô‡∏ß‡πå") || name.includes("‡∏≠‡∏±‡∏ô‡∏¢‡∏≠‡∏á")) {
                    mulBlock = (name.includes("5 ‡∏ä‡∏¥‡πâ‡∏ô") ? 5 : 1);
                }

                sumBL += (qty * mulBL);
                sumCut8 += (qty * mulCut8);
                sumBlock += (qty * mulBlock);

                // Hourly
                timeCols.forEach(t => {
                    let hQty = cleanNum(row[t.idx]);
                    if(hQty > 0) {
                        hourlySales[t.label] += hQty;
                        hourlyPrepData[t.label].total_sales += hQty;
                        hourlyPrepData[t.label].bl += (hQty * mulBL);
                        hourlyPrepData[t.label].cut8 += (hQty * mulCut8);
                        hourlyPrepData[t.label].block += (hQty * mulBlock);
                    }
                });

                // Packaging Logic
                let nameLower = name.toLowerCase();
                let descLower = desc.toLowerCase();
                
                // Detection: Code 5237 OR Keywords OR 'cat' prefix
                let isDel = (code === '5237') || 
                            TARGETS.DELIVERY_KEYS.some(k => nameLower.includes(k) || descLower.includes(k));

                let riceBox = 0, spoon = 0, knife = 0;
                
                if(name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) {
                    let setSize = 1;
                    if(name.includes("2 ‡∏ó‡∏µ‡πà") || name.includes("‡∏ä‡∏∏‡∏î‡∏Ñ‡∏π‡πà")) setSize = 2;
                    if(name.includes("3 ‡∏ó‡∏µ‡πà")) setSize = 3;
                    riceBox = qty * setSize;
                    spoon = qty * setSize;
                } else if(name.includes("‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á")) {
                    let pcs = mulBL + mulCut8; 
                    if(pcs === 0 && name.includes("‡∏ä‡∏¥‡πâ‡∏ô")) {
                         let m = name.match(/(\d+)/); if(m) pcs = parseInt(m[1]);
                    }
                    let pairs = (pcs > 4) ? 2 : (pcs > 0 ? 1 : 0);
                    knife = qty * pairs;
                } else if(name.includes("‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤")) {
                    knife = qty;
                }

                // Bucket Data
                if(isDel) {
                    packagingData.del.r += riceBox;
                    packagingData.del.s += spoon;
                    packagingData.del.k += knife;
                } else {
                    packagingData.wi.r += riceBox;
                    packagingData.wi.s += spoon;
                    packagingData.wi.k += knife;
                }

                cleanRows.push({ name, qty, mulBL, mulCut8, mulBlock });
            }

            daysInFile = uniqueDates.size || 1;

            // Update UI
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            document.getElementById('dashboard-screen').classList.add('animate-up');

            document.getElementById('kpi-bl').innerText = sumBL.toLocaleString();
            document.getElementById('kpi-cut8').innerText = sumCut8.toLocaleString();
            document.getElementById('kpi-block').innerText = sumBlock.toLocaleString();
            document.getElementById('kpi-sales').innerText = totalSales.toLocaleString();

            document.getElementById('suggest-bl').innerText = Math.ceil(sumBL * 1.1).toLocaleString();
            document.getElementById('suggest-cut8').innerText = Math.ceil(sumCut8 * 1.1).toLocaleString();
            document.getElementById('suggest-block').innerText = Math.ceil(sumBlock * 1.1).toLocaleString();

            renderMaterialsTable();
            renderCharts(timeCols.map(t => t.label), hourlySales, productSummary);
            renderPrepTable(timeCols.map(t => t.label));
            updatePackaging(30);
        }

        function updatePackaging(percent) {
            if(percent !== undefined) document.getElementById('disp-percent').innerText = percent + "%";
            else percent = document.getElementById('slider-percent').value;
            
            let ratio = percent / 100;
            let leftovers = parseInt(document.getElementById('input-leftover').value) || 0;
            // Leftovers: assume 1 person = 1 box + 1 spoon set
            let totalLeftovers = leftovers * daysInFile; 

            // Calculate Totals
            let useRice = packagingData.del.r + Math.ceil(packagingData.wi.r * ratio) + totalLeftovers;
            let useSpoon = packagingData.del.s + Math.ceil(packagingData.wi.s * ratio) + totalLeftovers;
            let useKnife = packagingData.del.k + Math.ceil(packagingData.wi.k * ratio);

            // Display Usage
            document.getElementById('pkg-rice').innerText = useRice.toLocaleString();
            document.getElementById('pkg-rice-del').innerText = packagingData.del.r.toLocaleString();
            document.getElementById('pkg-rice-wi').innerText = Math.ceil(packagingData.wi.r * ratio).toLocaleString();

            document.getElementById('pkg-spoon').innerText = useSpoon.toLocaleString();
            document.getElementById('pkg-spoon-del').innerText = packagingData.del.s.toLocaleString();
            document.getElementById('pkg-spoon-wi').innerText = Math.ceil(packagingData.wi.s * ratio).toLocaleString();

            document.getElementById('pkg-knife').innerText = useKnife.toLocaleString();
            document.getElementById('pkg-knife-del').innerText = packagingData.del.k.toLocaleString();
            document.getElementById('pkg-knife-wi').innerText = Math.ceil(packagingData.wi.k * ratio).toLocaleString();

            // Update Order Plan (Safety Stock 15%)
            let safeRice = Math.ceil(useRice * 1.15);
            let safeSpoon = Math.ceil(useSpoon * 1.15);
            let safeKnife = Math.ceil(useKnife * 1.15);

            document.getElementById('plan-use-rice').innerText = useRice.toLocaleString();
            document.getElementById('plan-order-rice').innerText = safeRice.toLocaleString();

            document.getElementById('plan-use-spoon').innerText = useSpoon.toLocaleString();
            document.getElementById('plan-order-spoon').innerText = safeSpoon.toLocaleString();

            document.getElementById('plan-use-knife').innerText = useKnife.toLocaleString();
            document.getElementById('plan-order-knife').innerText = safeKnife.toLocaleString();
        }

        function renderMaterialsTable() {
            const blList = cleanRows.filter(r => r.mulBL > 0).sort((a,b) => (b.qty*b.mulBL) - (a.qty*a.mulBL));
            document.getElementById('table-bl').innerHTML = blList.slice(0,50).map(r => `<tr class="border-b hover:bg-orange-50"><td class="py-2 pl-2">${r.name}</td><td class="py-2 text-right pr-2">${(r.qty*r.mulBL).toLocaleString()}</td></tr>`).join('');
            
            const c8List = cleanRows.filter(r => r.mulCut8 > 0).sort((a,b) => (b.qty*b.mulCut8) - (a.qty*a.mulCut8));
            document.getElementById('table-cut8').innerHTML = c8List.slice(0,50).map(r => `<tr class="border-b hover:bg-yellow-50"><td class="py-2 pl-2">${r.name}</td><td class="py-2 text-right pr-2">${(r.qty*r.mulCut8).toLocaleString()}</td></tr>`).join('');

            const bkList = cleanRows.filter(r => r.mulBlock > 0).sort((a,b) => (b.qty*b.mulBlock) - (a.qty*a.mulBlock));
            document.getElementById('table-block').innerHTML = bkList.slice(0,50).map(r => `<tr class="border-b hover:bg-emerald-50"><td class="py-2 pl-2">${r.name}</td><td class="py-2 text-right pr-2">${(r.qty*r.mulBlock).toLocaleString()}</td></tr>`).join('');
        }

        function renderPrepTable(times) {
            times.sort();
            let html = "";
            times.forEach(t => {
                let d = hourlyPrepData[t];
                if(d.bl + d.cut8 + d.block > 0) {
                    html += `<tr class="hover:bg-slate-50 border-b">
                        <td class="px-6 py-2 font-bold text-slate-700">${t}</td>
                        <td class="px-6 py-2 text-orange-600">${d.bl.toFixed(0)}</td>
                        <td class="px-6 py-2 text-yellow-600">${d.cut8.toFixed(0)}</td>
                        <td class="px-6 py-2 text-green-600">${d.block.toFixed(0)}</td>
                        <td class="px-6 py-2 text-right font-bold">${(d.bl+d.cut8+d.block).toFixed(0)}</td>
                    </tr>`;
                }
            });
            document.getElementById('table-prep').innerHTML = html;
        }

        function renderCharts(labels, salesData, productSummary) {
            labels.sort();
            
            // 1. Hourly Chart
            const ctx1 = document.getElementById('chart-hourly').getContext('2d');
            if(chartHourly) chartHourly.destroy();
            chartHourly = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á',
                        data: labels.map(l => salesData[l]),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 2. Prep Chart
            const ctx2 = document.getElementById('chart-prep').getContext('2d');
            if(chartPrep) chartPrep.destroy();
            chartPrep = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'BL ‡∏™‡∏î', data: labels.map(l => hourlyPrepData[l].bl), backgroundColor: '#ea580c' },
                        { label: 'Cut 8', data: labels.map(l => hourlyPrepData[l].cut8), backgroundColor: '#eab308' },
                        { label: 'Block', data: labels.map(l => hourlyPrepData[l].block), backgroundColor: '#10b981' }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { x: {stacked: true}, y: {stacked: true} }
                }
            });

            // 3. Top 10 Chart (Horizontal)
            const top10 = Object.entries(productSummary)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx3 = document.getElementById('chart-top10').getContext('2d');
            if(chartTop10) chartTop10.destroy();
            chartTop10 = new Chart(ctx3, {
                type: 'bar',
                indexAxis: 'y', // Horizontal
                data: {
                    labels: top10.map(i => i[0].length > 15 ? i[0].substr(0,15)+'...' : i[0]),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢',
                        data: top10.map(i => i[1]),
                        backgroundColor: '#e11d48'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function switchTab(view, btn) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            
            document.querySelectorAll('button').forEach(b => {
                if(b.classList.contains('tab-active')) {
                    b.classList.remove('tab-active');
                    b.classList.add('tab-inactive');
                }
            });
            btn.classList.remove('tab-inactive');
            btn.classList.add('tab-active');
        }
        
        function loadDemo() { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏£‡∏±‡∏ö"); }
    </script>
</body>
</html>


